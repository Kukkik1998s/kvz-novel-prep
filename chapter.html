<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏ó‡∏¢‡πà‡∏≠‡∏¢</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #f9f9f9; }
    input, textarea, button { display: block; margin: 5px 0; padding: 10px; width: 100%; }
    .chapter-item { border: 1px solid #999; background: #fff; padding: 10px; margin-top: 20px; border-radius: 8px; }
    .sub-item { margin-left: 20px; border-top: 1px dashed #aaa; padding-top: 10px; }
  </style>
</head>
<body>
  <h2>üìñ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å</h2>
  <input type="text" id="chapter-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô">
  <button onclick="addChapter()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≠‡∏ô</button>

  <h2>üìã ‡∏ï‡∏≠‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
  <div id="chapterList"></div>

  <div id="subModal" style="display:none; border:1px solid #ccc; padding:10px; background:#eee;">
    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô <span id="currentChapterTitle"></span></h3>
    <input type="text" id="sub-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô‡∏¢‡πà‡∏≠‡∏¢">
    <textarea id="sub-content" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤"></textarea>
    <button onclick="saveSubchapter()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ó‡∏¢‡πà‡∏≠‡∏¢</button>
    <button onclick="closeSubModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>

  <script type="module">
    import { db } from './firebase-init.js';
    import {
      ref, push, onValue, update, remove, get
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

    const chapterList = document.getElementById("chapterList");
    let chapterOrder = [];

    const subModal = document.getElementById("subModal");
    const subTitleInput = document.getElementById("sub-title");
    const subContentInput = document.getElementById("sub-content");
    const currentChapterTitle = document.getElementById("currentChapterTitle");

    let currentChapterId = null;

    function addChapter() {
      const title = document.getElementById("chapter-title").value.trim();
      if (title) {
        const order = chapterOrder.length;
        push(ref(db, 'chapters'), { title, order });
        document.getElementById("chapter-title").value = '';
      }
    }

    function renderChapters(data) {
      chapterList.innerHTML = "";
      chapterOrder = [];

      Object.entries(data)
        .sort((a, b) => (a[1].order || 0) - (b[1].order || 0))
        .forEach(([chapterId, chapter]) => {
          chapterOrder.push(chapterId);
          const div = document.createElement("div");
          div.className = "chapter-item";
          div.dataset.id = chapterId;

          const subchapters = chapter.subchapters || {};
          const subOrder = Object.entries(subchapters)
            .sort((a, b) => (a[1].order || 0) - (b[1].order || 0))
            .map(([subId, sub]) => `
              <div class="sub-item" data-id="${subId}">
                <strong>${sub.title}</strong>
                <p>${sub.content}</p>
                <button onclick="deleteSubchapter('${chapterId}', '${subId}')">‡∏•‡∏ö‡∏ö‡∏ó‡∏¢‡πà‡∏≠‡∏¢</button>
              </div>
            `).join("");

          div.innerHTML = `
            <strong>${chapter.title}</strong>
            <button onclick="deleteChapter('${chapterId}')">‡∏•‡∏ö</button>
            <button onclick="openSubModal('${chapterId}', '${chapter.title}')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏¢‡πà‡∏≠‡∏¢</button>
            <div class="sub-list" id="sublist-${chapterId}">
              ${subOrder || '<em>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡∏¢‡πà‡∏≠‡∏¢</em>'}
            </div>
          `;
          chapterList.appendChild(div);

          Sortable.create(document.getElementById(`sublist-${chapterId}`), {
            animation: 150,
            onEnd: () => {
              const ids = Array.from(document.getElementById(`sublist-${chapterId}`).children).map(el => el.dataset.id);
              ids.forEach((subId, index) => {
                update(ref(db, `chapters/${chapterId}/subchapters/${subId}`), { order: index });
              });
            }
          });
        });

      Sortable.create(chapterList, {
        animation: 200,
        onEnd: () => {
          const ids = Array.from(chapterList.children).map(el => el.dataset.id);
          ids.forEach((id, index) => {
            update(ref(db, `chapters/${id}`), { order: index });
          });
        }
      });
    }

    function loadChapters() {
      onValue(ref(db, 'chapters'), (snapshot) => {
        const data = snapshot.val() || {};
        renderChapters(data);
      });
    }

    window.deleteChapter = (id) => {
      if (confirm("‡∏•‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏ö‡∏ó‡∏¢‡πà‡∏≠‡∏¢)?")) {
        remove(ref(db, `chapters/${id}`));
      }
    };

    window.openSubModal = (chapterId, title) => {
      currentChapterId = chapterId;
      currentChapterTitle.innerText = title;
      subModal.style.display = 'block';
    };

    window.closeSubModal = () => {
      currentChapterId = null;
      subModal.style.display = 'none';
      subTitleInput.value = "";
      subContentInput.value = "";
    };

    window.saveSubchapter = () => {
      if (!currentChapterId) return;

      const title = subTitleInput.value.trim();
      const content = subContentInput.value.trim();
      if (title && content) {
        const subRef = ref(db, `chapters/${currentChapterId}/subchapters`);
        get(subRef).then(snapshot => {
          const data = snapshot.val() || {};
          const order = Object.keys(data).length;
          push(subRef, { title, content, order });
          closeSubModal();
        });
      }
    };

    window.deleteSubchapter = (chapterId, subId) => {
      if (confirm("‡∏•‡∏ö‡∏ö‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        remove(ref(db, `chapters/${chapterId}/subchapters/${subId}`));
      }
    };

    loadChapters();
  </script>
</body>
</html>
