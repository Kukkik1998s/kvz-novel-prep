<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Export ‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <h1>üì§ Export ‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô PDF</h1>
  <button onclick="exportAll()">‡∏™‡∏£‡πâ‡∏≤‡∏á PDF</button>

  <script type="module">
    import { db } from './firebase-init.js';
    import { get, ref } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

    async function exportAll() {
      const [themes, characters, worlds, chapters] = await Promise.all([
        get(ref(db, 'themes')),
        get(ref(db, 'characters')),
        get(ref(db, 'worlds')),
        get(ref(db, 'chapters'))
      ]);

      const themeData = themes.val() || {};
      const charData = characters.val() || {};
      const worldData = worlds.val() || {};
      const chapterData = chapters.val() || {};

      let html = `<h1>‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</h1>`;

      html += `<h2>1. ‡∏ò‡∏µ‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</h2>`;
      Object.values(themeData).forEach(t => {
        html += `<h3>${t.title}</h3><p><strong>‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢:</strong> ${t.summary}</p><p><strong>‡∏û‡∏•‡πá‡∏≠‡∏ï:</strong><br>${t.plot}</p>`;
      });

      html += `<h2>2. ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h2>`;
      Object.values(charData).forEach(c => {
        html += `<p><strong>${c.name}</strong> (${c.gender}, ${c.age})<br>${c.description}</p>`;
      });

      html += `<h2>3. ‡πÇ‡∏•‡∏Å‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</h2>`;
      Object.values(worldData).forEach(w => {
        html += `<h3>${w.name}</h3><p>${w.description}</p>`;
      });

      html += `<h2>4. ‡∏ï‡∏≠‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</h2>`;
      Object.entries(chapterData)
        .sort((a, b) => (a[1].order || 0) - (b[1].order || 0))
        .forEach(([cid, chap]) => {
          html += `<h3>${chap.title}</h3>`;
          if (chap.subchapters) {
            Object.entries(chap.subchapters)
              .sort((a, b) => (a[1].order || 0) - (b[1].order || 0))
              .forEach(([_, sub]) => {
                html += `<h4>${sub.title}</h4><p>${sub.content}</p>`;
              });
          }
        });

      const opt = {
        margin: 0.5,
        filename: 'novel-full-export.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      html2pdf().from(html).set(opt).save();
    }
  </script>
</body>
</html>
